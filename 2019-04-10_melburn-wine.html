<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>LIME Wine</title>
    <meta charset="utf-8" />
    <meta name="author" content="@mdneuzerling" />
    <meta name="date" content="2019-04-10" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
    <script src="libs/kePrint-0.0.1/kePrint.js"></script>
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# LIME Wine
## Melbourne Users of R Network (MelbURN)
### <span class="citation">@mdneuzerling</span>
### 2019-04-10

---

## Data load



.pull-left[

```r
wine &lt;- "winemag-data-130k-v2.csv" %&gt;% 
  read_csv %&gt;%
  rename(index = X1) %&gt;% 
  mutate(
    variety = variety %&gt;% tolower,
    # missing data filled from description
    variety = ifelse(
      index == 86909, 
      "petite syrah", 
      variety
    ) 
  )
```


```r
wine %&gt;% 
    sample_n(30000) %&gt;% 
    visdat::vis_dat()
```
]

.pull-right[
&lt;img src="2019-04-10_melburn-wine_files/figure-html/wine_vis_dat_out-1.png" width="500" height="500" /&gt;
]

---
## Points

.pull-left[
Wine is rated from 80 to 100 *points*:


```r
red_wine_colour &lt;- "#59121C"
white_wine_colour &lt;- "#EADB9F"
rosé_wine_colour &lt;- "#F5C0A2"
wine_plot_colours &lt;- c(
  "red" = red_wine_colour, 
  "white" = white_wine_colour,
  "rosé" = rosé_wine_colour
)
```


```r
wine %&gt;% ggplot(aes(x = points)) + 
  geom_histogram(
    bins = nrow(wine %&gt;% distinct(points)),
    colour = white_wine_colour,
    fill = red_wine_colour
  )
```

Thanks to Deanna Neuzerling for the colour scheme!
]

.pull-right[
&lt;img src="2019-04-10_melburn-wine_files/figure-html/wine_point_histogram_out-1.png" width="500" height="500" /&gt;
]

---
class: inverse
## Wine colours

I like red wine. I don't like white wine.

&lt;center&gt;
&lt;img src="wine-tasting-notes.jpg" alt="The top half of a page of wine tasting notes. The white wines are noted as tasting white. There are no notes for the red wines." style="width: 55%; height: 55%;"&gt;&lt;/img&gt;
&lt;/center&gt;


---
## Wine colours

.pull-left[
Scraping wine colours with R:
[https://mdneuzerling.com/post/scraping-wine-colours-with-r/](https://mdneuzerling.com/post/scraping-wine-colours-with-r/)


```r
wine &lt;- wine %&gt;% left_join(
  read_csv("variety_colours.csv"),
  by = "variety"
)
```


```r
wine %&gt;% 
  ggplot(aes(x = colour, fill = colour)) + 
  geom_bar() + 
  scale_fill_manual(
    values = wine_plot_colours
  ) + 
  ggtitle("Wine colours") +
  theme(legend.position="none")
```
]

.pull-right[
&lt;img src="2019-04-10_melburn-wine_files/figure-html/wine_colours_plot_out-1.png" width="500" height="500" /&gt;
]

---
## This is what an 80-point wine is like

A 1998 French red blend:

.pull-left[

```r
wine %&gt;% 
    filter(index == 11086) %&gt;% 
    select(description) %&gt;% 
    paste0('&gt; ', .) %&gt;% # print as quote
    cat
```
]

.pull-right[
&gt; Picture grandma standing over a pot of stewed prunes, which fill the dusty old house with their sickly aromas. Cooked, earthy and rustic, this wine has little going for it. Just barely acceptable.
]

---
## Tennis balls?

Tennis balls are mentioned in 7 wine reviews. This Californian sauvignon blanc got 88 points:

.pull-left[

```r
wine %&gt;% 
    filter(index == 12834) %&gt;% 
    select(description) %&gt;% 
    paste0('&gt; ', .) %&gt;% # print as quote
    cat
```
]

.pull-right[
&gt; Quite grassy and brisk in style, this wine releases generous aromas of cut tennis ball, wet cement and sour limes. That citrusy acidity and sour-grass energy picks up lime pith, green-apple skins and a touch of white pepper on the palate, a very classic profile.
]

---
## Word frequency

.pull-left[

```r
wine_words &lt;- wine %&gt;% 
  tidytext::unnest_tokens(
    word, 
    description
  ) %&gt;% 
  anti_join(
    tidytext::stop_words, 
    by = "word"
  ) 
```
]

.pull-right[

```r
wine_words %&gt;% 
  select(index, word) %&gt;% 
  head %&gt;% 
  output_table
```

&lt;table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; index &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; word &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; aromas &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; include &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; tropical &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; fruit &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; broom &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; brimstone &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]

---
## Word frequency

.pull-left[

```r
wine_words %&gt;%
  count(word, colour, sort = TRUE) %&gt;%
  head(20) %&gt;%
  mutate(word = reorder(word, n)) %&gt;%
  ggplot(aes(word, n, fill = colour)) +
  geom_col() + 
  scale_fill_manual(
    values = wine_plot_colours
  ) +
  xlab(NULL) +
  theme(text = element_text(size = 16)) +
  coord_flip() +
  ggtitle("Frequency of words") +
  theme(legend.position = "none")
```
]

.pull-right[
&lt;img src="2019-04-10_melburn-wine_files/figure-html/wine_1grams_plot_out-1.png" width="500" height="500" /&gt;
]

---
## Word frequency

.pull-left[
I'm not sure what purpose word clouds serve, but they seem compulsory at this point.


```r
wine_words %&gt;%
  count(word) %&gt;%
  with(
    wordcloud::wordcloud(
      word, 
      n, 
      max.words = 100
    )
  )
```
]

.pull-right[
&lt;img src="2019-04-10_melburn-wine_files/figure-html/word_cloud_out-1.png" width="500" height="500" /&gt;
]

---
## 2-gram frequency

.pull-left[

```r
wine_2grams &lt;- wine %&gt;%  
  tidytext::unnest_tokens(
    ngram, 
    description, 
    token = "ngrams", 
    n = 2
  ) %&gt;% 
  separate(
    ngram, 
    c("word1", "word2"), 
    sep = " ", 
    remove = FALSE
  ) %&gt;% 
  filter_at(
    vars(starts_with("word")), 
    all_vars(
      !(. %in% tidytext::stop_words$word)
    )
  )
```
]

.pull-right[

```r
wine_2grams %&gt;% 
  select(index, ngram, word1, word2) %&gt;% 
  head %&gt;% 
  output_table
```

&lt;table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; index &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; ngram &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; word1 &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; word2 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; aromas include &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; aromas &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; include &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; include tropical &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; include &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; tropical &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; tropical fruit &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; tropical &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; fruit &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; fruit broom &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; fruit &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; broom &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; broom brimstone &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; broom &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; brimstone &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; dried herb &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; dried &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; herb &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]

---
## 2-gram frequency

.pull-left[

```r
wine_2grams %&gt;%
  count(ngram, colour, sort = TRUE) %&gt;%
  head(20) %&gt;%
  mutate(ngram = reorder(ngram, n)) %&gt;%
  ggplot(aes(ngram, n, fill = colour)) +
  geom_col() +
  scale_fill_manual(
    values = wine_plot_colours
  ) +
  xlab(NULL) +
  coord_flip() + 
  ggtitle("Frequency of 2-grams") +
  theme(legend.position = "none")
```
]

.pull-right[
&lt;img src="2019-04-10_melburn-wine_files/figure-html/wine_2grams_plot_out-1.png" width="500" height="500" /&gt;
]

---
class: inverse
## Vectorising

We'll be loosely following [Shirin Glander's](https://shirinsplayground.netlify.com/2018/07/explaining_ml_models_code_text_lime/) approach to preprocessing here, which identifies the following steps:

1. stem and tokenise
1. generate a vocabulary
1. remove stop words 
1. prune the vocabulary 
1. transform into a vector space 

--

We need a function that maps an **arbitrary string** onto this vector space.

---
## Stem and tokenise

.pull-left[

```r
stem_tokeniser &lt;- function(x) {
    lapply(
        text2vec::word_tokenizer(x), 
        SnowballC::wordStem, 
        language = "en"
    )
}
```
]

.pull-right[

```r
stem_tokeniser(
  "Dreaming sufficient identical usually"
)
```

```
## [[1]]
## [1] "Dream"   "suffici" "ident"   "usual"
```


```r
stem_tokeniser(
  "information informed informing informs"
)
```

```
## [[1]]
## [1] "inform" "inform" "inform" "inform"
```
]

---
## Generate a vocabulary, remove stop words and prune

.pull-left[

```r
wine_tokens &lt;- text2vec::itoken(
  wine$description, 
  preprocessor = tolower, 
  tokenizer = stem_tokeniser,
  progressbar = FALSE
)

vocabulary &lt;- text2vec::create_vocabulary(
  wine_tokens, 
  stopwords = tidytext::stop_words$word
) %&gt;% 
  text2vec::prune_vocabulary(
    doc_proportion_min = 0.01,
    doc_proportion_max = 0.25
  )
```
]

.pull-right[

```r
vocabulary
```

```
## Number of docs: 129971 
## 1149 stopwords: a, a's, able, about, above, according ... 
## ngram_min = 1; ngram_max = 1 
## Vocabulary: 
##            term term_count doc_count
##   1:    graphit       1306      1300
##   2:      anoth       1310      1301
##   3: honeysuckl       1315      1307
##   4:      excel       1326      1302
##   5:     brambl       1331      1327
##  ---                                
## 359:        dri      26516     24436
## 360:      black      29050     24481
## 361:       ripe      29141     27234
## 362:     tannin      32980     31959
## 363:     cherri      33589     31328
```
]

---
class: inverse
## Vectoriser

Our `vectoriser` will take an arbitrary string and map it to these 363 stemmed terms. 

Any new terms will be **ignored**.


```r
vectoriser &lt;- vocabulary %&gt;% text2vec::vocab_vectorizer()
```

---
## Document term matrices

* Every column is one of our 363 terms
* Every row is a wine review
* Values are weighted by *term frequency–inverse document frequency (tf-idf)*


```r
map_to_dtm &lt;- function(text, vectorizer = vectoriser) {
  vocab &lt;- text2vec::itoken(
    text, 
    preprocess_function = tolower, 
    tokenizer = stem_tokeniser,
    progressbar = FALSE)

  dtm &lt;- text2vec::create_dtm(vocab, vectorizer = vectorizer)

  tfidf = text2vec::TfIdf$new()
  text2vec::fit_transform(dtm, tfidf)
}
```

---
## Document term matrices


```r
wine_dtm &lt;- wine$description %&gt;% map_to_dtm
wine_dtm %&gt;% dim
```

```
## [1] 129971    363
```


```r
paste0('&gt; ', wine[1,]$description) %&gt;% cat
```

&gt; Aromas include tropical fruit, broom, brimstone and dried herb. The palate isn't overly expressive, offering unripened apple, citrus and dried sage alongside brisk acidity.


```r
tail(wine_dtm[1,], 20)
```

```
##      soft      appl    textur     offer     sweet      plum     light 
## 0.0000000 0.1886876 0.0000000 0.1767235 0.0000000 0.0000000 0.0000000 
##      nose       oak     berri       red     fresh      rich     spice 
## 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 
##      note       dri     black      ripe    tannin    cherri 
## 0.0000000 0.2891878 0.0000000 0.0000000 0.0000000 0.0000000
```

---
## xgboost


```r
xgb &lt;- xgboost::xgb.train(
  list(
    max_depth = 7, 
    eta = 0.1, 
    objective = "reg:linear",
    eval_metric = "rmse"
  ),
  data = xgboost::xgb.DMatrix(
    wine_dtm, 
    label = wine$points
  ),
  nrounds = 1000
)
```

---
## LIME

.pull-left[

```r
wine_explainer &lt;- lime::lime(
  wine$description,
  xgb,
  preprocess = map_to_dtm
)
```
]

.pull-right[

&gt;There once was a package called lime,

&gt;Whose models were simply sublime,

&gt;It gave explanations for their variations,

&gt;one observation at a time.

*lime-rick* by Mara Averick
]

&lt;center&gt;
&lt;img src="lime-logo.png" alt="The logo for the lime package for R. It's a green hexagonal logo that looks like the inside of a lime fruit." style="width: 18%; height: 18%;"&gt;&lt;/img&gt;
&lt;/center&gt;

---
## LIME

.pull-left[

```r
sample_wine &lt;- wine %&gt;% 
  filter(index == 71573)
sample_wine_explanation &lt;- lime::explain(
  sample_wine$description,
  wine_explainer,
  n_features = 10
)

paste0("&gt; ", sample_wine$description) %&gt;% 
  cat
```

&gt; Rich and creamy, showing tangerine, apricot, buttered toast, cinnamon spice and herb flavors. A solid wine for drinking with roast salmon, seared tuna or a salad of bitter greens with goat cheese and orange slices.
]

.pull-right[
&lt;img src="2019-04-10_melburn-wine_files/figure-html/xgb_explanation_plot-1.png" width="500" height="500" /&gt;
]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
