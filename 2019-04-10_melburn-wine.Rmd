---
title: "LIME Wine"
subtitle: "Melbourne Users of R Network (MelbURN)"
author: "@mdneuzerling"
date: "2019-04-10"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
## Data load

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)

library(tidyverse)

# nifty function for making our table output pretty
output_table <- function(dat) {
  knitr::kable(dat, format = "html") %>% 
  kableExtra::kable_styling(full_width = F)
}
```

.pull-left[
```{r wine_data_load, message=FALSE, warning=FALSE, cache=TRUE}
wine <- "winemag-data-130k-v2.csv" %>% 
  read_csv %>%
  rename(index = X1) %>% 
  mutate(
    variety = variety %>% tolower,
    # missing data filled from description
    variety = ifelse(
      index == 86909, 
      "petite syrah", 
      variety
    ) 
  )
```

```{r wine_vis_dat, eval=FALSE, cache=TRUE}
wine %>% 
    sample_n(30000) %>% 
    visdat::vis_dat()
```
]

.pull-right[
```{r wine_vis_dat_out, ref.label="wine_vis_dat", echo=FALSE, dpi = 300, fig.width = 5, fig.height = 5, out.height = 500, out.width = 500}
```
]

---
## Points

.pull-left[
Wine is rated from 80 to 100 *points*:

```{r wine_point_histogram, eval=FALSE}
red_wine_colour <- "#59121C"
white_wine_colour <- "#EADB9F"
rosé_wine_colour <- "#F5C0A2"
wine_plot_colours <- c(
  "red" = red_wine_colour, 
  "white" = white_wine_colour,
  "rosé" = rosé_wine_colour
)

wine %>% ggplot(aes(x = points)) + 
  geom_histogram(
    bins = nrow(wine %>% distinct(points)),
    colour = white_wine_colour,
    fill = red_wine_colour
  )
```

Thanks to Deanna Neuzerling for the colour scheme!
]

.pull-right[
```{r wine_point_histogram_out, ref.label="wine_point_histogram", echo=FALSE, dpi = 300, fig.width = 5, fig.height = 5, out.height = 500, out.width = 500}
```
]

---
class: inverse
## Wine colours

I like red wine. I don't like white wine.

<center>
<img src="wine-tasting-notes.jpg" alt="The top half of a page of wine tasting notes. The white wines are noted as tasting white. There are no notes for the red wines." style="width: 55%; height: 55%;"></img>
</center>


---
## Wine colours

.pull-left[
Scraping wine colours with R:
[https://mdneuzerling.com/post/scraping-wine-colours-with-r/](https://mdneuzerling.com/post/scraping-wine-colours-with-r/)

```{r joining_with_variety_colours, message=FALSE}
wine <- wine %>% left_join(
  read_csv("variety_colours.csv"),
  by = "variety"
)
```

```{r wine_colours_plot, eval=FALSE}
wine %>% 
  ggplot(aes(x = colour, fill = colour)) + 
  geom_bar() + 
  scale_fill_manual(
    values = wine_plot_colours
  ) + 
  ggtitle("Wine colours") +
  theme(legend.position="none")
```
]

.pull-right[
```{r wine_colours_plot_out, ref.label="wine_colours_plot", echo=FALSE, dpi = 300, fig.width = 5, fig.height = 5, out.height = 500, out.width = 500}
```
]

---
## This is what an 80-point wine is like

A 1998 French red blend:

.pull-left[
```{r grandma_wine, eval=FALSE}
wine %>% 
    filter(index == 11086) %>% 
    select(description) %>% 
    paste0('> ', .) %>% # print as quote
    cat
```
]

.pull-right[
```{r grandma_wine_out, ref.label="grandma_wine", echo=FALSE, results='asis'}
```
]

---
## Tennis balls?

Tennis balls are mentioned in `r wine %>% filter(grepl("tennis ball", description)) %>% nrow` wine reviews. This Californian sauvignon blanc got 88 points:

.pull-left[
```{r tennis_ball_wine, eval=FALSE}
wine %>% 
    filter(index == 12834) %>% 
    select(description) %>% 
    paste0('> ', .) %>% # print as quote
    cat
```
]

.pull-right[
```{r tennis_ball_wine_out, ref.label="tennis_ball_wine", echo=FALSE, results='asis'}
```
]

---
## Word frequency

.pull-left[
```{r wine_words, cache=TRUE}
wine_words <- wine %>% 
  tidytext::unnest_tokens(
    word, 
    description
  ) %>% 
  anti_join(
    tidytext::stop_words, 
    by = "word"
  ) 
```
]

.pull-right[
```{r wine_words_head}
wine_words %>% 
  select(index, word) %>% 
  head %>% 
  output_table
```
]

---
## Word frequency

.pull-left[
```{r wine_1grams_plot, eval=FALSE}
wine_words %>%
  count(word, colour, sort = TRUE) %>%
  head(20) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = colour)) +
  geom_col() + 
  scale_fill_manual(
    values = wine_plot_colours
  ) +
  xlab(NULL) +
  theme(text = element_text(size = 16)) +
  coord_flip() +
  ggtitle("Frequency of words") +
  theme(legend.position = "none")
```
]

.pull-right[
```{r wine_1grams_plot_out, ref.label="wine_1grams_plot", echo=FALSE, dpi = 300, fig.width = 5, fig.height = 5, out.height = 500, out.width = 500}
```
]

---
## Word frequency

.pull-left[
I'm not sure what purpose word clouds serve, but they seem compulsory at this point.

```{r word_cloud, eval=FALSE}
wine_words %>%
  count(word) %>%
  with(
    wordcloud::wordcloud(
      word, 
      n, 
      max.words = 100
    )
  )
```
]

.pull-right[
```{r word_cloud_out, ref.label="word_cloud", echo=FALSE, dpi = 300, fig.width = 5, fig.height = 5, out.height = 500, out.width = 500}
```
]

---
## 2-gram frequency

.pull-left[
```{r 2grams, cache=TRUE}
wine_2grams <- wine %>%  
  tidytext::unnest_tokens(
    ngram, 
    description, 
    token = "ngrams", 
    n = 2
  ) %>% 
  separate(
    ngram, 
    c("word1", "word2"), 
    sep = " ", 
    remove = FALSE
  ) %>% 
  filter_at(
    vars(starts_with("word")), 
    all_vars(
      !(. %in% tidytext::stop_words$word)
    )
  )
```
]

.pull-right[
```{r 2grams_head}
wine_2grams %>% 
  select(index, ngram, word1, word2) %>% 
  head %>% 
  output_table
```
]

---
## 2-gram frequency

.pull-left[
```{r wine_2grams_plot, eval=FALSE}
wine_2grams %>%
  count(ngram, colour, sort = TRUE) %>%
  head(20) %>%
  mutate(ngram = reorder(ngram, n)) %>%
  ggplot(aes(ngram, n, fill = colour)) +
  geom_col() +
  scale_fill_manual(
    values = wine_plot_colours
  ) +
  xlab(NULL) +
  coord_flip() + 
  ggtitle("Frequency of 2-grams") +
  theme(legend.position = "none")
```
]

.pull-right[
```{r wine_2grams_plot_out, ref.label="wine_2grams_plot", echo=FALSE, dpi = 300, fig.width = 5, fig.height = 5, out.height = 500, out.width = 500}
```
]

---
class: inverse
## Vectorising

We'll be loosely following [Shirin Glander's](https://shirinsplayground.netlify.com/2018/07/explaining_ml_models_code_text_lime/) approach to preprocessing here, which identifies the following four steps:

1. remove stop words 
1. stem the tokens 
1. prune the vocabulary 
1. transform into a vector space 

--

We need a function that maps an **arbitrary string** onto this vector space.

---
## Tokenizer

.pull-left[
```{r stem_tokeniser}
stem_tokeniser <- function(x) {
    lapply(
        text2vec::word_tokenizer(x), 
        SnowballC::wordStem, 
        language = "en"
    )
}
```
]

.pull-right[
```{r stem_tokeniser_example_1}
stem_tokeniser(
  "Dreaming sufficient identical usually"
)
```

```{r stem_tokeniser_example_2}
stem_tokeniser(
  "information informed informing informs"
)
```
]
